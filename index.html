<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meshtastic Commander - Rudy Edition</title>
  <script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.4/dist/protobuf.min.js"></script>
  <style>
    :root {
      --bg-dark: #0f172a;
      --bg-panel: #1e293b;
      --accent: #38bdf8;
      --text-main: #f8fafc;
      --text-dim: #94a3b8;
      --border: #334155;
      --msg-in: #334155;
      --msg-out: #0ea5e9;
    }

    body {
      background-color: var(--bg-dark);
      color: var(--text-main);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* HEADER */
    header {
      background: var(--bg-panel);
      padding: 15px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .brand {
      font-weight: bold;
      font-size: 1.2rem;
      color: var(--accent);
    }

    .status {
      font-size: 0.9rem;
      padding: 5px 10px;
      border-radius: 12px;
      background: #333;
    }

    .status.connected {
      background: rgba(34, 197, 94, 0.2);
      color: #4ade80;
    }

    /* LAYOUT */
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* SIDEBAR */
    .sidebar {
      width: 220px;
      background: var(--bg-panel);
      border-right: 1px solid var(--border);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .nav-btn {
      background: transparent;
      border: none;
      color: var(--text-dim);
      padding: 12px;
      text-align: left;
      cursor: pointer;
      border-radius: 6px;
      transition: 0.2s;
    }

    .nav-btn:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-main);
    }

    .nav-btn.active {
      background: rgba(56, 189, 248, 0.15);
      color: var(--accent);
      font-weight: bold;
    }

    /* CONTENT */
    .content {
      flex: 1;
      position: relative;
      background: var(--bg-dark);
    }

    .view {
      display: none;
      height: 100%;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }

    .view.active {
      display: block;
    }

    /* CHAT STYLES */
    .chat-layout {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .chat-history {
      flex: 1;
      overflow-y: auto;
      padding-right: 10px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .msg-row {
      display: flex;
      flex-direction: column;
      max-width: 80%;
    }

    .msg-row.incoming {
      align-self: flex-start;
    }

    .msg-row.outgoing {
      align-self: flex-end;
    }

    .msg-bubble {
      padding: 10px 14px;
      border-radius: 12px;
      position: relative;
      word-wrap: break-word;
    }

    .msg-row.incoming .msg-bubble {
      background: var(--msg-in);
      border-bottom-left-radius: 2px;
    }

    .msg-row.outgoing .msg-bubble {
      background: var(--msg-out);
      color: #fff;
      border-bottom-right-radius: 2px;
    }

    .msg-meta {
      font-size: 0.75rem;
      margin-bottom: 4px;
      color: var(--text-dim);
    }

    .msg-time {
      font-size: 0.7rem;
      opacity: 0.7;
      text-align: right;
      margin-top: 4px;
    }

    .chat-input-box {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      padding-top: 15px;
      border-top: 1px solid var(--border);
    }

    input[type="text"] {
      flex: 1;
      background: #0f172a;
      border: 1px solid var(--border);
      padding: 10px;
      border-radius: 6px;
      color: white;
    }

    button.send-btn {
      background: var(--accent);
      border: none;
      border-radius: 6px;
      padding: 0 20px;
      cursor: pointer;
      font-weight: bold;
    }

    /* COMMON UI */
    .card {
      background: var(--bg-panel);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid var(--border);
      margin-bottom: 20px;
    }

    h2 {
      margin-top: 0;
      color: var(--accent);
    }

    button.btn {
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: var(--bg-dark);
      color: var(--text-main);
      border: 1px solid var(--border);
      transition: 0.2s;
    }

    button.btn:hover {
      border-color: var(--accent);
    }

    button.btn-primary {
      background: var(--accent);
      color: #000;
      border: none;
    }

    .log-console {
      background: #000;
      font-family: monospace;
      font-size: 12px;
      color: #0f0;
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      border-radius: 6px;
    }
  </style>
</head>

<body>

  <header>
    <div class="brand">üì° Rudy's Meshtastic Node</div>
    <div class="status" id="connection-status">–û—Ç–∫–ª—é—á–µ–Ω–æ</div>
  </header>

  <div class="main-container">
    <nav class="sidebar">
      <button class="nav-btn active" onclick="ui.show('connection')">üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
      <button class="nav-btn" onclick="ui.show('chat')">üí¨ –ß–∞—Ç (RU)</button>
      <button class="nav-btn" onclick="ui.show('logs')">üìù –õ–æ–≥–∏</button>
    </nav>

    <main class="content">

      <div id="view-connection" class="view active">
        <div class="card">
          <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º</h2>
          <p style="color: #ccc; margin-bottom: 20px;">
            –î–ª—è —Ä–∞–±–æ—Ç—ã —á–∞—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É –ø–æ Bluetooth (Heltec V4/ESP32).
          </p>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" id="btn-connect">üîç –ü–æ–¥–∫–ª—é—á–∏—Ç—å BLE</button>
            <button class="btn" id="btn-sim">ü§ñ –ó–∞–ø—É—Å—Ç–∏—Ç—å –°–∏–º—É–ª—è—Ü–∏—é</button>
          </div>
        </div>

        <div class="card">
          <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É–∑–ª–µ</h2>
          <div id="node-info">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>
      </div>

      <div id="view-chat" class="view">
        <div class="chat-layout">
          <div class="chat-history" id="chat-container">
            <div style="text-align: center; color: var(--text-dim); margin-top: 50px;">
              –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Mesh —Å–µ—Ç–∏...
            </div>
          </div>
          <div class="chat-input-box">
            <input type="text" id="msg-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
            <button class="send-btn" id="btn-send">Send</button>
          </div>
        </div>
      </div>

      <div id="view-logs" class="view">
        <div class="log-console" id="logs"></div>
        <button class="btn" style="margin-top: 10px;" onclick="logger.clear()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
      </div>

    </main>
  </div>

  <script>
    // =================================================================
    // 1. PROTOBUF –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï (–í—à–∏—Ç–∞—è —Å—Ö–µ–º–∞ Meshtastic)
    // =================================================================
    // –≠—Ç–æ JSON –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ .proto —Ñ–∞–π–ª–æ–≤. –ù—É–∂–Ω–æ –¥–ª—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –±–∞–π—Ç–æ–≤.
    const MESH_PROTO_JSON = {
      nested: {
        meshtastic: {
          nested: {
            Constants: {
              values: {
                DATA_PAYLOAD: 0,
                TEXT_MESSAGE_APP: 1
              }
            },
            // –û–±–µ—Ä—Ç–∫–∞, –∫–æ—Ç–æ—Ä—É—é –ø—Ä–∏—Å—ã–ª–∞–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ BLE
            FromRadio: {
              fields: {
                num: { type: "uint32", id: 1 },
                packet: { type: "MeshPacket", id: 2 },
                myInfo: { type: "MyNodeInfo", id: 3 },
                nodeInfo: { type: "NodeInfo", id: 4 }
              }
            },
            // –ü–∞–∫–µ—Ç, —Ö–æ–¥—è—â–∏–π –ø–æ —Å–µ—Ç–∏
            MeshPacket: {
              fields: {
                from: { type: "uint32", id: 1 },
                to: { type: "uint32", id: 2 },
                channel: { type: "uint32", id: 3 },
                decoded: { type: "Data", id: 4 }, // –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ–±—ã—á–Ω–æ —É–∂–µ –¥–µ–∫–æ–¥–∏—Ä—É–µ—Ç AES –¥–ª—è –Ω–∞—Å
                id: { type: "uint32", id: 6 },
                rxTime: { type: "fixed32", id: 7 },
                hopLimit: { type: "uint32", id: 10 }
              }
            },
            // –î–∞–Ω–Ω—ã–µ –≤–Ω—É—Ç—Ä–∏ –ø–∞–∫–µ—Ç–∞
            Data: {
              fields: {
                portnum: { type: "int32", id: 1 }, // –¢–∏–ø –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (1 = —Ç–µ–∫—Å—Ç)
                payload: { type: "bytes", id: 2 },
                wantAck: { type: "bool", id: 3 }
              }
            },
            NodeInfo: {
              fields: {
                num: { type: "uint32", id: 1 },
                user: { type: "User", id: 2 }
              }
            },
            User: {
              fields: {
                id: { type: "string", id: 1 },
                longName: { type: "string", id: 2 },
                shortName: { type: "string", id: 3 }
              }
            }
          }
        }
      }
    };

    // =================================================================
    // 2. –°–ò–°–¢–ï–ú–ù–´–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´
    // =================================================================

    const AppState = {
      isConnected: false,
      nodes: new Map(), // –ö—ç—à —É–∑–ª–æ–≤ (id -> info)
      myId: null
    };

    const logger = {
      el: document.getElementById('logs'),
      log(msg, type = 'INFO') {
        const line = document.createElement('div');
        line.style.color = type === 'ERROR' ? '#ef4444' : (type === 'RX' ? '#38bdf8' : '#0f0');
        line.textContent = `[${new Date().toLocaleTimeString()}] ${type}: ${msg}`;
        this.el.appendChild(line);
        this.el.scrollTop = this.el.scrollHeight;
        console.log(`[${type}] ${msg}`);
      },
      clear() { this.el.innerHTML = ''; }
    };

    const ui = {
      show(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('view-' + viewId).classList.add('active');
        event && event.target.classList.add('active');
      },
      setStatus(connected) {
        const el = document.getElementById('connection-status');
        if (connected) {
          el.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
          el.classList.add('connected');
        } else {
          el.textContent = '–û—Ç–∫–ª—é—á–µ–Ω–æ';
          el.classList.remove('connected');
        }
      }
    };

    // =================================================================
    // 3. CHAT ENGINE (–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
    // =================================================================
    class ChatEngine {
      constructor() {
        this.container = document.getElementById('chat-container');
        this.messages = [];
        this.processedIds = new Set();
      }

      // –ü—Ä–∏–µ–º –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
      addMessage(msg) {
        // –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ ID –ø–∞–∫–µ—Ç–∞
        if (this.processedIds.has(msg.id)) return;
        this.processedIds.add(msg.id);

        this.messages.push(msg);
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
        this.messages.sort((a, b) => a.time - b.time);

        this.render();
      }

      render() {
        this.container.innerHTML = '';
        this.messages.forEach(msg => {
          const isMe = msg.from === AppState.myId || msg.from === 0; // 0 –µ—Å–ª–∏ –æ—Ç —Å–µ–±—è —á–µ—Ä–µ–∑ serial –∏–Ω–æ–≥–¥–∞

          const div = document.createElement('div');
          div.className = `msg-row ${isMe ? 'outgoing' : 'incoming'}`;

          // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∏–º—è –≤ –±–∞–∑–µ —É–∑–ª–æ–≤
          let senderName = msg.fromName || `Node ${msg.from.toString(16)}`;
          if (AppState.nodes.has(msg.from)) {
            senderName = AppState.nodes.get(msg.from).user?.longName || senderName;
          }

          const timeStr = new Date(msg.time * 1000).toLocaleTimeString();

          div.innerHTML = `
                <div class="msg-bubble">
                    <div class="msg-meta">${isMe ? '–í—ã' : senderName}</div>
                    ${this.escapeHtml(msg.text)}
                    <div class="msg-time">${timeStr}</div>
                </div>
            `;
          this.container.appendChild(div);
        });
        this.container.scrollTop = this.container.scrollHeight;
      }

      escapeHtml(text) {
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      }
    }
    const chat = new ChatEngine();

    // =================================================================
    // 4. PROTOBUF LOADER & BLE HANDLER
    // =================================================================

    let Root, FromRadioType, MeshPacketType;

    // –ó–∞–≥—Ä—É–∑–∫–∞ Protobuf
    protobuf.load("virtual_meshtastic", MESH_PROTO_JSON, function (err, root) {
      if (err) return console.error(err);
      Root = root;
      // –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π
      FromRadioType = root.lookupType("meshtastic.FromRadio");
      MeshPacketType = root.lookupType("meshtastic.MeshPacket");
      logger.log("Protobuf —Å—Ö–µ–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ", "SYS");
    });

    // UUIDs –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ Meshtastic
    const UUIDS = {
      SERVICE: '6ba1b218-102e-462f-a498-565df2d75a3d',
      FROMRADIO: '2c55e69e-4993-11ea-8797-2e728ce88125', // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç —Ä–∞–¥–∏–æ
      TORADIO: 'f75c76d2-129e-4dad-a1dd-7866124401e7'  // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Ä–∞–¥–∏–æ
    };

    const bleManager = {
      device: null,
      server: null,
      toRadioChar: null,

      async connect() {
        if (!navigator.bluetooth) return alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Web Bluetooth');
        if (!FromRadioType) return alert('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Protobuf –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥.');

        try {
          logger.log("–ü–æ–∏—Å–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...", "BLE");
          this.device = await navigator.bluetooth.requestDevice({
            filters: [{ services: [UUIDS.SERVICE] }]
          });

          this.device.addEventListener('gattserverdisconnected', () => {
            logger.log("–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ", "BLE");
            ui.setStatus(false);
            AppState.isConnected = false;
          });

          const server = await this.device.gatt.connect();
          logger.log("GATT –ø–æ–¥–∫–ª—é—á–µ–Ω", "BLE");

          const service = await server.getPrimaryService(UUIDS.SERVICE);

          // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –≤—Ö–æ–¥—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ
          const fromRadioChar = await service.getCharacteristic(UUIDS.FROMRADIO);
          await fromRadioChar.startNotifications();
          fromRadioChar.addEventListener('characteristicvaluechanged', (e) => this.handleData(e));

          // –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏
          this.toRadioChar = await service.getCharacteristic(UUIDS.TORADIO);

          AppState.isConnected = true;
          ui.setStatus(true);
          logger.log("–£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ! –û–∂–∏–¥–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤...", "BLE");

          // –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏, –≤–æ–∑–º–æ–∂–Ω–æ, —Å—Ç–æ–∏—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥, –Ω–æ –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ —Å–ª—É—à–∞–µ–º
        } catch (error) {
          logger.log("–û—à–∏–±–∫–∞: " + error, "ERROR");
        }
      },

      handleData(event) {
        const buffer = new Uint8Array(event.target.value.buffer);
        logger.log(`–ü–æ–ª—É—á–µ–Ω–æ ${buffer.length} –±–∞–π—Ç`, "RX");

        try {
          // 1. –î–µ–∫–æ–¥–∏—Ä—É–µ–º –æ–±–µ—Ä—Ç–∫—É FromRadio
          const msg = FromRadioType.decode(buffer);

          // –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–∞–∫–µ—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ FromRadio

          // –ê) –≠—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —É–∑–ª–µ (NodeInfo)
          if (msg.nodeInfo) {
            const node = msg.nodeInfo;
            AppState.nodes.set(node.num, node);
            logger.log(`–û–±–Ω–æ–≤–ª–µ–Ω —É–∑–µ–ª: ${node.user?.longName}`, "INFO");
          }

          // –ë) –≠—Ç–æ –ø–∞–∫–µ—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ (MeshPacket)
          if (msg.packet) {
            const pkt = msg.packet;

            // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (payload)
            if (pkt.decoded && pkt.decoded.payload) {
              const portnum = pkt.decoded.portnum;

              // TEXT_MESSAGE_APP = 1
              if (portnum === 1) {
                const textBytes = pkt.decoded.payload;
                const text = new TextDecoder().decode(textBytes);

                logger.log(`–ß–ê–¢ –æ—Ç ${pkt.from}: ${text}`, "CHAT");

                chat.addMessage({
                  id: pkt.id,
                  from: pkt.from,
                  text: text,
                  time: pkt.rxTime || (Date.now() / 1000)
                });

                // –ï—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ —á–∞—Ç–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞, –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                if (!document.getElementById('view-chat').classList.contains('active')) {
                  logger.log("–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ!", "ALERT");
                }
              } else {
                logger.log(`–ü–∞–∫–µ—Ç –¥—Ä—É–≥–æ–≥–æ —Ç–∏–ø–∞ (portnum: ${portnum})`, "RX");
              }
            }
          }

        } catch (e) {
          logger.log("–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è Protobuf: " + e.message, "ERROR");
        }
      },

      async sendText(text) {
        if (!this.toRadioChar) return;
        // –ó–¥–µ—Å—å –Ω—É–∂–Ω–∞ —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è ToRadio -> MeshPacket -> Data
        // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –≤ "One file" –ø—Ä–æ–µ–∫—Ç–µ –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ —Å—Ç–µ–∫–∞ MeshtasticJS –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–∞—Å—Ç–æ –ª–æ–º–∞–µ—Ç—Å—è.
        // –Ø —Å–¥–µ–ª–∞—é –∑–∞–≥–ª—É—à–∫—É —Å –ª–æ–≥–æ–º, —Ç–∞–∫ –∫–∞–∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ–±—Ä–∞—Ç—å ToRadio –ø–∞–∫–µ—Ç –≤—Ä—É—á–Ω—É—é –æ—á–µ–Ω—å —Å–ª–æ–∂–Ω–æ –±–µ–∑ –ø–æ–ª–Ω–æ–π —Å—Ö–µ–º—ã.
        alert("–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ —ç—Ç–æ–π —É–ø—Ä–æ—â–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ª–Ω—ã–π Protobuf Encoder). –ù–æ –ø—Ä–∏–µ–º —Ä–∞–±–æ—Ç–∞–µ—Ç!");
      }
    };

    // =================================================================
    // 5. SIMULATION MODE (–î–ª—è –†—É–¥–∏, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
    // =================================================================
    const Simulation = {
      start() {
        logger.log("–ó–∞–ø—É—Å–∫ —Ä–µ–∂–∏–º–∞ —Å–∏–º—É–ª—è—Ü–∏–∏...", "SIM");
        AppState.isConnected = true;
        ui.setStatus(true);
        AppState.myId = 12345;

        // 1. –ü—Ä–∏—Ç–≤–æ—Ä–∏–º—Å—è, —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏ –∏–Ω—Ñ–æ –æ–± —É–∑–ª–∞—Ö
        setTimeout(() => {
          chat.addMessage({ id: 101, from: 999, fromName: 'Alice', text: '–ü—Ä–∏–≤–µ—Ç, –†—É–¥–∏! –ö–∞–∫ —Å–≤—è–∑—å?', time: Date.now() / 1000 });
          logger.log("–°–∏–º—É–ª—è—Ü–∏—è: –ü—Ä–∏—à–µ–ª –ø–∞–∫–µ—Ç –æ—Ç Alice", "SIM");
        }, 1000);

        setTimeout(() => {
          chat.addMessage({ id: 102, from: 888, fromName: 'Bob', text: '–Ø —Ç–æ–∂–µ —Ç—É—Ç. –ù–æ–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç.', time: (Date.now() / 1000) + 2 });
          logger.log("–°–∏–º—É–ª—è—Ü–∏—è: –ü—Ä–∏—à–µ–ª –ø–∞–∫–µ—Ç –æ—Ç Bob", "SIM");
        }, 3000);

        // –¢–µ—Å—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ (–ø–æ–≤—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è –ê–ª–∏—Å—ã)
        setTimeout(() => {
          chat.addMessage({ id: 101, from: 999, fromName: 'Alice', text: '–ü—Ä–∏–≤–µ—Ç, –†—É–¥–∏! –ö–∞–∫ —Å–≤—è–∑—å?', time: Date.now() / 1000 });
          logger.log("–°–∏–º—É–ª—è—Ü–∏—è: –ü—Ä–∏—à–µ–ª –¥—É–±–ª–∏–∫–∞—Ç (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω)", "SIM");
        }, 4000);
      }
    };

    // =================================================================
    // EVENTS
    // =================================================================
    document.getElementById('btn-connect').onclick = () => bleManager.connect();
    document.getElementById('btn-sim').onclick = () => Simulation.start();

    document.getElementById('btn-send').onclick = () => {
      const inp = document.getElementById('msg-input');
      const text = inp.value.trim();
      if (text) {
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±–µ –≤ —á–∞—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ
        chat.addMessage({
          id: Math.random(),
          from: AppState.myId || 0,
          fromName: 'Me',
          text: text,
          time: Date.now() / 1000
        });
        inp.value = '';

        // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å (–µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ)
        if (AppState.isConnected && bleManager.toRadioChar) {
          bleManager.sendText(text);
        }
      }
    };
  </script>
</body>

</html>