<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meshtastic Control - Rudy Release</title>

  <script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.4/dist/protobuf.min.js"></script>

  <style>
    :root {
      --bg-dark: #121212;
      --bg-panel: #1e1e1e;
      --accent: #4CAF50;
      /* Meshtastic Green */
      --text: #e0e0e0;
      --text-muted: #a0a0a0;
      --border: #333;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg-dark);
      color: var(--text);
      font-family: 'Segoe UI', sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--bg-panel);
      padding: 15px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      margin: 0;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status {
      font-size: 0.8rem;
      padding: 5px 10px;
      border-radius: 12px;
      background: #333;
    }

    .status.connected {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
    }

    main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* –°–∞–π–¥–±–∞—Ä */
    aside {
      width: 250px;
      background: #181818;
      border-right: 1px solid var(--border);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    button {
      background: var(--bg-panel);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 10px;
      cursor: pointer;
      border-radius: 6px;
      text-align: left;
      transition: 0.2s;
    }

    button:hover {
      background: #2a2a2a;
      border-color: var(--accent);
    }

    button.primary {
      background: var(--accent);
      color: white;
      border: none;
      text-align: center;
    }

    /* –ß–∞—Ç –∑–æ–Ω–∞ */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-dark);
      position: relative;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .msg {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 12px;
      position: relative;
      animation: fadeIn 0.2s ease;
      word-wrap: break-word;
    }

    .msg.in {
      align-self: flex-start;
      background: var(--bg-panel);
      border-bottom-left-radius: 2px;
    }

    .msg.out {
      align-self: flex-end;
      background: #2e7d32;
      border-bottom-right-radius: 2px;
    }

    .msg-header {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    .input-area {
      padding: 15px;
      background: var(--bg-panel);
      display: flex;
      gap: 10px;
    }

    input[type="text"] {
      flex: 1;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #121212;
      color: white;
    }

    /* –õ–æ–≥–∏ (—Å–∫—Ä—ã—Ç—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å) */
    #logs {
      height: 150px;
      background: black;
      color: #0f0;
      font-family: monospace;
      font-size: 0.8rem;
      padding: 10px;
      overflow-y: auto;
      border-top: 1px solid var(--border);
      display: none;
      /* –°–∫—Ä—ã—Ç–æ, –ø–æ–∫–∞ –Ω–µ –Ω–∞–∂–º–µ—à—å –∫–Ω–æ–ø–∫—É */
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>

  <header>
    <h1>üì° Rudy's Meshtastic Node</h1>
    <div class="status" id="status-indicator">–û—Ç–∫–ª—é—á–µ–Ω–æ</div>
  </header>

  <main>
    <aside>
      <button class="primary" id="btn-connect">üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å (BLE)</button>
      <div style="margin-top: auto;">
        <div style="font-size: 0.8rem; color: #666; padding: 5px;">DEBUG TOOLS</div>
        <button
          onclick="document.getElementById('logs').style.display = document.getElementById('logs').style.display === 'block' ? 'none' : 'block'">üìù
          –õ–æ–≥–∏</button>
        <button onclick="app.sendSimulatedMessage()">ü§ñ –¢–µ—Å—Ç –ß–∞—Ç–∞</button>
      </div>
    </aside>

    <div class="chat-area">
      <div id="messages">
        <div style="text-align: center; color: #666; margin-top: 50px;">
          –ù–∞–∂–º–∏ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å", –≤—ã–±–µ—Ä–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ Meshtastic.<br>
          –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å.
        </div>
      </div>
      <div class="input-area">
        <input type="text" id="msg-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
        <button class="primary" id="btn-send" style="width: auto;" disabled>Send</button>
      </div>
    </div>
  </main>

  <div id="logs"></div>

  <script>
    // ==========================================
    // 1. –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –°–•–ï–ú–´ PROTOBUF (–°–õ–û–í–ê–†–¨)
    // ==========================================
    // –≠—Ç–æ "—Å–ª–æ–≤–∞—Ä—å", —á—Ç–æ–±—ã JS –ø–æ–Ω–∏–º–∞–ª —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö Meshtastic.
    // –í–∑—è—Ç–æ –∏–∑ meshtastic.proto (—É–ø—Ä–æ—â–µ–Ω–æ –¥–ª—è —á–∞—Ç–∞)

    const MESHTASTIC_PROTO_JSON = {
      "nested": {
        "meshtastic": {
          "nested": {
            "PortNum": {
              "values": {
                "UNKNOWN_APP": 0,
                "TEXT_MESSAGE_APP": 1,
                "POSITION_APP": 3,
                "NODEINFO_APP": 4
              }
            },
            "MeshPacket": {
              "fields": {
                "from": { "type": "fixed32", "id": 1 },
                "to": { "type": "fixed32", "id": 2 },
                "decoded": { "type": "Data", "id": 4 },
                "id": { "type": "fixed32", "id": 6 },
                "rxTime": { "type": "fixed32", "id": 7 },
                "hopLimit": { "type": "uint32", "id": 10 }
              }
            },
            "Data": {
              "fields": {
                "portnum": { "type": "PortNum", "id": 1 },
                "payload": { "type": "bytes", "id": 2 },
                "wantAck": { "type": "bool", "id": 3 },
                "source": { "type": "fixed32", "id": 4 }
              }
            },
            "FromRadio": {
              "fields": {
                "packet": { "type": "MeshPacket", "id": 11 },
                "myInfo": { "type": "MyNodeInfo", "id": 3 },
                "nodeInfo": { "type": "NodeInfo", "id": 4 }
              }
            },
            "MyNodeInfo": {
              "fields": {
                "myNodeNum": { "type": "fixed32", "id": 1 }
              }
            },
            "NodeInfo": {
              "fields": {
                "num": { "type": "fixed32", "id": 1 },
                "user": { "type": "User", "id": 2 }
              }
            },
            "User": {
              "fields": {
                "id": { "type": "string", "id": 1 },
                "longName": { "type": "string", "id": 2 },
                "shortName": { "type": "string", "id": 3 }
              }
            },
            "ToRadio": {
              "fields": {
                "packet": { "type": "MeshPacket", "id": 1 },
                "wantConfigId": { "type": "uint32", "id": 100 } // —É–ø—Ä–æ—â–µ–Ω–æ
              }
            }
          }
        }
      }
    };

    // ==========================================
    // 2. –ì–õ–ê–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
    // ==========================================

    const UUIDS = {
      SERVICE: '6ba1b218-102e-462f-a498-565df2d75a3d',
      TORADIO: 'f75c76d2-129e-4dad-a1dd-7866124401e7', // –ü–∏—à–µ–º —Å—é–¥–∞
      FROMRADIO: '2c55e69e-4993-11ea-8797-2e728ce88125'  // –ß–∏—Ç–∞–µ–º –æ—Ç—Å—é–¥–∞
    };

    const app = {
      root: null, // Protobuf Root
      Types: {},  // –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã
      device: null,
      characteristic: null, // FromRadio
      writer: null, // ToRadio
      myNodeId: 0,
      nodeDb: {}, // –ë–∞–∑–∞ –∏–º–µ–Ω —É–∑–ª–æ–≤: { 12345: "Alice" }
      processedIds: new Set(), // –ß—Ç–æ–±—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      async init() {
        this.log("–ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π Protobuf...");
        try {
          this.root = protobuf.Root.fromJSON(MESHTASTIC_PROTO_JSON);
          this.Types.FromRadio = this.root.lookupType("meshtastic.FromRadio");
          this.Types.ToRadio = this.root.lookupType("meshtastic.ToRadio");
          this.Types.MeshPacket = this.root.lookupType("meshtastic.MeshPacket");
          this.log("Protobuf –≥–æ—Ç–æ–≤.");
        } catch (e) {
          this.log("–û–®–ò–ë–ö–ê –∑–∞–≥—Ä—É–∑–∫–∏ Protobuf: " + e.message, "error");
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.");
        }
      },

      // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Bluetooth
      async connect() {
        if (!this.root) await this.init();

        try {
          this.log("–ü–æ–∏—Å–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...");
          this.device = await navigator.bluetooth.requestDevice({
            filters: [{ services: [UUIDS.SERVICE] }]
          });

          this.device.addEventListener('gattserverdisconnected', () => this.onDisconnect());

          this.log("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ GATT...");
          const server = await this.device.gatt.connect();
          const service = await server.getPrimaryService(UUIDS.SERVICE);

          // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á—Ç–µ–Ω–∏—è (FromRadio)
          this.characteristic = await service.getCharacteristic(UUIDS.FROMRADIO);
          await this.characteristic.startNotifications();
          this.characteristic.addEventListener('characteristicvaluechanged', (e) => this.handleData(e));

          // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–ø–∏—Å–∏ (ToRadio)
          this.writer = await service.getCharacteristic(UUIDS.TORADIO);

          this.onConnect();

          // –ó–∞–ø—Ä–æ—Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ–±–µ (Handshake)
          // –í –ø—Ä–æ—Å—Ç–µ–π—à–µ–º —Å–ª—É—á–∞–µ –ø—Ä–æ—Å—Ç–æ –∂–¥–µ–º, –Ω–æ–¥–∞ —Å–∞–º–∞ –ø—Ä–∏—à–ª–µ—Ç MyInfo –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

        } catch (e) {
          this.log("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: " + e, "error");
        }
      },

      onConnect() {
        document.getElementById('status-indicator').textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ";
        document.getElementById('status-indicator').classList.add('connected');
        document.getElementById('btn-connect').style.display = 'none';
        document.getElementById('msg-input').disabled = false;
        document.getElementById('btn-send').disabled = false;
        this.log("–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ –ø—Ä–∏–µ–º—É –¥–∞–Ω–Ω—ã—Ö.");
      },

      onDisconnect() {
        document.getElementById('status-indicator').textContent = "–û—Ç–∫–ª—é—á–µ–Ω–æ";
        document.getElementById('status-indicator').classList.remove('connected');
        document.getElementById('btn-connect').style.display = 'block';
        this.log("–°–≤—è–∑—å –ø–æ—Ç–µ—Ä—è–Ω–∞.", "error");
      },

      // –û–ë–†–ê–ë–û–¢–ö–ê –í–•–û–î–Ø–©–ò–• –ë–ê–ô–¢–û–í (–°–ê–ú–û–ï –í–ê–ñ–ù–û–ï!)
      handleData(event) {
        const buffer = new Uint8Array(event.target.value.buffer);
        try {
          // 1. –î–µ–∫–æ–¥–∏—Ä—É–µ–º –æ–±–µ—Ä—Ç–∫—É FromRadio
          const fromRadio = this.Types.FromRadio.decode(buffer);

          // 2. –°–º–æ—Ç—Ä–∏–º, —á—Ç–æ –≤–Ω—É—Ç—Ä–∏
          if (fromRadio.myInfo) {
            this.myNodeId = fromRadio.myInfo.myNodeNum;
            this.log(`–ú–æ–π NodeID –æ–ø—Ä–µ–¥–µ–ª–µ–Ω: ${this.myNodeId}`);
          }

          if (fromRadio.nodeInfo) {
            // –ü—Ä–∏—à–ª–∞ –∏–Ω—Ñ–∞ –æ–± —É–∑–ª–µ (–∏–º—è –∏ —Ç.–¥.)
            const num = fromRadio.nodeInfo.num;
            const name = fromRadio.nodeInfo.user?.longName || fromRadio.nodeInfo.user?.shortName;
            if (name) {
              this.nodeDb[num] = name;
              this.log(`–£–∑–Ω–∞–ª–∏ –∏–º—è —É–∑–ª–∞ ${num}: ${name}`);
            }
          }

          if (fromRadio.packet) {
            this.processMeshPacket(fromRadio.packet);
          }

        } catch (e) {
          this.log("–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞–∫–µ—Ç–∞: " + e, "warn");
        }
      },

      processMeshPacket(packet) {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–µ–π
        if (this.processedIds.has(packet.id)) return;
        this.processedIds.add(packet.id);

        // –ï—Å–ª–∏ –Ω–µ—Ç decoded –¥–∞–Ω–Ω—ã—Ö (—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ –∏–ª–∏ —Å–ª—É–∂–µ–±–Ω–æ–µ), –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–∫–∞
        if (!packet.decoded) return;

        // –ü–æ—Ä—Ç 1 = TEXT_MESSAGE_APP
        if (packet.decoded.portnum === 1) {
          const bytes = packet.decoded.payload;
          const text = new TextDecoder("utf-8").decode(bytes);

          // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
          const senderName = this.nodeDb[packet.from] || `Node ${packet.from.toString(16)}`; // Hex –≤–∏–¥ ID

          this.uiAddMessage(senderName, text, false);
          this.log(`MSG –æ—Ç ${senderName}: ${text}`);
        }
      }
      ,

      // –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø
      async sendMessage() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if (!text || !this.writer) return;

        try {
          // 1. –°–æ–∑–¥–∞–µ–º Payload (—Ç–µ–∫—Å—Ç –≤ –±–∞–π—Ç—ã)
          const payloadBytes = new TextEncoder().encode(text);

          // 2. –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É MeshPacket
          // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π ID
          const packetId = Math.floor(Math.random() * 0xFFFFFFFF);

          const packetStruct = {
            to: 0xFFFFFFFF, // Broadcast (–≤—Å–µ–º)
            decoded: {
              portnum: 1, // TEXT_MESSAGE_APP
              payload: payloadBytes,
              wantAck: false
            },
            id: packetId
          };

          // 3. –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ ToRadio
          const toRadioStruct = {
            packet: packetStruct
          };

          // 4. –ö–æ–¥–∏—Ä—É–µ–º –≤ –±–∏–Ω–∞—Ä–Ω—ã–π –≤–∏–¥
          const err = this.Types.ToRadio.verify(toRadioStruct);
          if (err) throw Error(err);

          const buffer = this.Types.ToRadio.encode(toRadioStruct).finish();

          // 5. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É
          await this.writer.writeValue(buffer);

          // 6. UI
          this.uiAddMessage("–Ø (Rudy)", text, true);
          input.value = '';
          this.log("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —ç—Ñ–∏—Ä.");

        } catch (e) {
          this.log("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + e, "error");
        }
      },

      // UI HELPERS
      uiAddMessage(author, text, isMe) {
        const container = document.getElementById('messages');

        // –£–¥–∞–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
        if (container.querySelector('div[style*="text-align: center"]')) {
          container.innerHTML = '';
        }

        const div = document.createElement('div');
        div.className = `msg ${isMe ? 'out' : 'in'}`;

        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        div.innerHTML = `
      <div class="msg-header">
        <span>${author}</span>
        <span>${time}</span>
      </div>
      <div>${text}</div>
    `;

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
      },

      log(msg, type = 'info') {
        const el = document.getElementById('logs');
        const line = document.createElement('div');
        line.textContent = `> ${msg}`;
        if (type === 'error') line.style.color = 'red';
        if (type === 'warn') line.style.color = 'yellow';
        el.prepend(line);
        console.log(msg);
      },

      sendSimulatedMessage() {
        this.uiAddMessage("–°–∏—Å—Ç–µ–º–∞", "–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ï—Å–ª–∏ —Ç—ã –≤–∏–¥–∏—à—å —ç—Ç–æ, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–∞–±–æ—Ç–∞–µ—Ç.", false);
      }
    };

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = () => app.init();

    // –ë–∏–Ω–¥–∏–Ω–≥ –∫–Ω–æ–ø–æ–∫
    document.getElementById('btn-connect').onclick = () => app.connect();
    document.getElementById('btn-send').onclick = () => app.sendMessage();
    document.getElementById('msg-input').onkeypress = (e) => {
      if (e.key === 'Enter') app.sendMessage();
    };

  </script>
</body>

</html>