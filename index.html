<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meshtastic Control Panel - Rudy Final Edition</title>

  <script src="https://cdn.jsdelivr.net/npm/protobufjs@7.2.4/dist/protobuf.min.js"></script>

  <style>
    :root {
      --bg-dark: #0f172a;
      --bg-panel: #1e293b;
      --accent: #38bdf8;
      /* Meshtastic Blue */
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --border: #334155;
      --error: #ef4444;
      --success: #22c55e;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--bg-panel);
      padding: 15px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .title {
      font-size: 1.2rem;
      color: var(--accent);
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      background: rgba(239, 68, 68, 0.2);
      color: var(--error);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-badge.connected {
      background: rgba(34, 197, 94, 0.2);
      color: var(--success);
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
      box-shadow: 0 0 5px currentColor;
    }

    .main-layout {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Sidebar/Navigation */
    .sidebar {
      width: 200px;
      background: var(--bg-panel);
      border-right: 1px solid var(--border);
      padding: 10px;
    }

    .nav-btn {
      width: 100%;
      text-align: left;
      background: transparent;
      border: none;
      color: var(--text-muted);
      padding: 12px;
      margin-bottom: 5px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .nav-btn:hover {
      background: #2f3e53;
      color: var(--text);
    }

    .nav-btn.active {
      background: var(--accent);
      color: var(--bg-dark);
      font-weight: 600;
    }

    /* Content */
    .content-area {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      max-width: 100%;
    }

    .view-section {
      display: none;
      max-width: 900px;
      margin: 0 auto;
    }

    .view-section.active {
      display: block;
    }

    .card {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .card h2 {
      margin-bottom: 15px;
      font-size: 1.1rem;
      color: var(--accent);
    }

    /* Forms */
    input,
    select {
      width: 100%;
      background: #334155;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
      font-family: inherit;
    }

    button {
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
      background: var(--accent);
      color: var(--bg-dark);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    /* Chat */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 100px);
      background: #131d2c;
      border-radius: 8px;
    }

    #chat-messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .msg {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 12px;
      word-wrap: break-word;
    }

    .msg.in {
      align-self: flex-start;
      background: var(--bg-panel);
      border-bottom-left-radius: 2px;
    }

    .msg.out {
      align-self: flex-end;
      background: #0e7490;
      color: white;
      border-bottom-right-radius: 2px;
    }

    .msg-meta {
      font-size: 0.75rem;
      margin-bottom: 4px;
      opacity: 0.8;
    }

    .msg-time {
      font-size: 0.7rem;
      opacity: 0.6;
      margin-top: 5px;
      text-align: right;
    }

    .chat-input-area {
      padding: 15px;
      background: var(--bg-panel);
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
    }

    .chat-input-area input {
      margin-bottom: 0;
    }

    /* Logs */
    #log-output {
      background: #000;
      color: #0f0;
      font-family: 'Consolas', monospace;
      padding: 15px;
      height: 250px;
      overflow-y: auto;
      font-size: 0.8rem;
      border-radius: 6px;
    }

    .log-line {
      margin-bottom: 2px;
    }

    .log-time {
      color: #666;
      margin-right: 10px;
    }

    .log-WARN {
      color: #fbbf24;
    }

    .log-ERROR {
      color: #ef4444;
    }

    .log-SUCCESS {
      color: var(--success);
    }
  </style>
</head>

<body>

  <header>
    <div class="title">üõ∞Ô∏è Meshtastic Rudy-Controller</div>
    <div class="status-badge" id="global-status">
      <span class="status-indicator"></span>
      <span id="status-text">–û–∂–∏–¥–∞–Ω–∏–µ</span>
    </div>
  </header>

  <div class="main-layout">
    <nav class="sidebar">
      <button class="nav-btn active" onclick="router.navigate('connection')">üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
      <button class="nav-btn" onclick="router.navigate('chat')" id="nav-chat">üí¨ –ß–∞—Ç</button>
      <button class="nav-btn" onclick="router.navigate('nodes')">üë• –£–∑–ª—ã</button>
      <button class="nav-btn" onclick="router.navigate('config')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </nav>

    <main class="content-area">

      <div id="view-connection" class="view-section active">
        <div class="card">
          <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h2>
          <div class="btn-group" style="margin-bottom: 20px;">
            <button onclick="meshtasticClient.setMode('ble')">Bluetooth (WebBLE)</button>
            <button onclick="meshtasticClient.setMode('serial')">USB (Serial)</button>
            <button onclick="meshtasticClient.setMode('http')">Wi-Fi (HTTP)</button>
          </div>

          <div id="conn-form-ble" style="display: none;">
            <p style="margin-bottom: 10px; color: var(--text-muted);">–¢—Ä–µ–±—É–µ—Ç—Å—è Chrome/Edge –∏ HTTPS/localhost.</p>
            <button onclick="meshtasticClient.connectBLE()">üîç –ü–æ–¥–∫–ª—é—á–∏—Ç—å –ø–æ Bluetooth</button>
          </div>

          <div id="conn-form-serial" style="display: none;">
            <p style="margin-bottom: 10px; color: var(--text-muted);">–ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ USB-–ø–æ—Ä—Ç.</p>
            <button onclick="meshtasticClient.connectSerial()">üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å USB-–ø–æ—Ä—Ç</button>
          </div>

          <div id="conn-form-http" style="display: none;">
            <p style="margin-bottom: 10px; color: var(--text-muted);">–î–ª—è —Ä–∞–±–æ—Ç—ã Meshtastic –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ä–µ–∂–∏–º–µ Wi-Fi
              –∫–ª–∏–µ–Ω—Ç–∞/—Ç–æ—á–∫–∏ –¥–æ—Å—Ç—É–ø–∞.</p>
            <input type="text" id="http-ip" placeholder="IP –∞–¥—Ä–µ—Å –Ω–æ–¥—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, 192.168.42.1)"
              value="http://192.168.42.1">
            <button onclick="meshtasticClient.connectHTTP()">üåê –ü–æ–¥–∫–ª—é—á–∏—Ç—å –ø–æ Wi-Fi</button>
          </div>

          <div style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 20px;">
            <p style="color: var(--text-muted);">–ú–æ–π ID: <strong id="my-node-id">N/A</strong></p>
            <p style="color: var(--text-muted);">–ú–æ—ë –ò–º—è: <strong id="my-node-name">N/A</strong></p>
          </div>
        </div>
      </div>

      <div id="view-chat" class="view-section">
        <div class="chat-container">
          <div id="chat-messages">
            <div style="text-align: center; color: var(--text-muted); margin-top: 20px;">
              –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –Ω–æ–¥–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —á–∞—Ç.
            </div>
          </div>
          <div class="chat-input-area">
            <input type="text" id="msg-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
              onkeypress="if(event.key === 'Enter') chatEngine.send()" disabled>
            <button onclick="chatEngine.send()" id="btn-send" disabled>üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </div>
        </div>
      </div>

      <div id="view-nodes" class="view-section">
        <div class="card">
          <h2>–ò–∑–≤–µ—Å—Ç–Ω—ã–µ —É–∑–ª—ã –≤ Mesh-—Å–µ—Ç–∏</h2>
          <div id="node-list-container"
            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
            <p style="color: var(--text-muted);">–ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è —É–∑–ª—ã, –∫–∞–∫ —Ç–æ–ª—å–∫–æ –æ–Ω–∏ –±—É–¥—É—Ç –ø–æ–ª—É—á–µ–Ω—ã –æ—Ç –Ω–æ–¥—ã.</p>
          </div>
        </div>
      </div>

      <div id="view-config" class="view-section">
        <div class="card">
          <h2>–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–£–ø—Ä–æ—â–µ–Ω–Ω–æ)</h2>
          <p style="color: var(--text-muted); margin-bottom: 20px;">–î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–æ–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∞.
          </p>

          <label for="longNameInput" style="display: block; margin-bottom: 5px;">–ú–æ—ë –î–ª–∏–Ω–Ω–æ–µ –ò–º—è (LongName)</label>
          <input type="text" id="longNameInput" placeholder="Rudy">

          <label for="channelNameInput" style="display: block; margin-bottom: 5px;">–ò–º—è –ö–∞–Ω–∞–ª–∞ (Channel Name)</label>
          <input type="text" id="channelNameInput" placeholder="LongFast">

          <button onclick="alert('TODO: Implement config saving via ToRadio packet')">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
        <div class="card">
          <h2>–°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏</h2>
          <div id="log-output"></div>
          <button onclick="logger.clear()" style="margin-top: 10px;">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ==========================================
    // 1. –ö–û–ù–°–¢–ê–ù–¢–´ –ò –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø PROTOBUF
    // ==========================================

    const UUIDS = {
      SERVICE: '6ba1b218-102e-462f-a498-565df2d75a3d',
      TORADIO: 'f75c76d2-129e-4dad-a1dd-7866124401e7',
      FROMRADIO: '2c55e69e-4993-11ea-8797-2e728ce88125'
    };

    // –°—Ö–µ–º–∞ Protobuf Meshtastic (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞—è –¥–ª—è —á–∞—Ç–∞ –∏ —É–∑–ª–æ–≤)
    const MESHTASTIC_PROTO_JSON = {
      "nested": {
        "meshtastic": {
          "nested": {
            "PortNum": {
              "values": {
                "UNKNOWN_APP": 0,
                "TEXT_MESSAGE_APP": 1,
                "POSITION_APP": 3,
                "NODEINFO_APP": 4
              }
            },
            "MeshPacket": {
              "fields": {
                "from": { "type": "fixed32", "id": 1 },
                "to": { "type": "fixed32", "id": 2 },
                "decoded": { "type": "Data", "id": 4 },
                "id": { "type": "fixed32", "id": 6 },
                "rxTime": { "type": "fixed32", "id": 7 } // –í—Ä–µ–º—è, –∫–æ–≥–¥–∞ –Ω–æ–¥–∞ –ø–æ–ª—É—á–∏–ª–∞ –ø–∞–∫–µ—Ç
              }
            },
            "Data": {
              "fields": {
                "portnum": { "type": "PortNum", "id": 1 },
                "payload": { "type": "bytes", "id": 2 }
              }
            },
            "FromRadio": {
              "fields": {
                "packet": { "type": "MeshPacket", "id": 11 },
                "myInfo": { "type": "MyNodeInfo", "id": 3 },
                "nodeInfo": { "type": "NodeInfo", "id": 4 }
              }
            },
            "MyNodeInfo": { "fields": { "myNodeNum": { "type": "fixed32", "id": 1 } } },
            "NodeInfo": { "fields": { "num": { "type": "fixed32", "id": 1 }, "user": { "type": "User", "id": 2 } } },
            "User": { "fields": { "longName": { "type": "string", "id": 2 } } },
            "ToRadio": { "fields": { "packet": { "type": "MeshPacket", "id": 1 } } }
          }
        }
      }
    };

    // ==========================================
    // 2. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ö–õ–ê–°–°–´ (LOGGER, ROUTER)
    // ==========================================

    const logger = {
      el: document.getElementById('log-output'),
      log(level, msg) {
        if (!this.el) return;
        const time = new Date().toLocaleTimeString();
        const line = document.createElement('div');
        line.className = 'log-line';
        line.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${level}">${level}</span>: ${msg}`;
        this.el.appendChild(line);
        this.el.scrollTop = this.el.scrollHeight;
      },
      info(m) { this.log('INFO', m); },
      warn(m) { this.log('WARN', m); },
      error(m) { this.log('ERROR', m); },
      success(m) { this.log('SUCCESS', m); },
      clear() { this.el.innerHTML = ''; }
    };

    const router = {
      navigate(viewId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${viewId}`).classList.add('active');

        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[onclick="router.navigate('${viewId}')"]`).classList.add('active');
      }
    };

    // ==========================================
    // 3. CHAT ENGINE (–£–ü–û–†–Ø–î–û–ß–ò–í–ê–ù–ò–ï)
    // ==========================================

    class ChatEngine {
      constructor() {
        this.messages = [];
        this.processedIds = new Set();
        this.container = document.getElementById('chat-messages');
      }

      /**
       * –ü—Ä–∏–µ–º –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
       * @param {Object} msg - –æ–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è {id, fromId, fromName, text, timestamp}
       */
      incomingMessage(msg) {
        if (this.processedIds.has(msg.id)) {
          logger.log('DEBUG', `Deduplicator: Ignored duplicate message ID ${msg.id}`);
          return;
        }
        this.processedIds.add(msg.id);

        // –î–æ–±–∞–≤–ª—è–µ–º –∏ –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ timestamp (rxTime - –≤—Ä–µ–º—è, –∫–æ–≥–¥–∞ –ø–∞–∫–µ—Ç –±—ã–ª —Å–æ–∑–¥–∞–Ω/–ø–æ–ª—É—á–µ–Ω –Ω–æ–¥–æ–π)
        this.messages.push(msg);
        this.messages.sort((a, b) => a.timestamp - b.timestamp);

        this.render();
      }

      render() {
        this.container.innerHTML = '';

        if (this.messages.length === 0) {
          this.container.innerHTML = '<div style="text-align: center; color: var(--text-muted); margin-top: 20px;">–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>';
          return;
        }

        this.messages.forEach(msg => {
          const isMe = msg.fromId === meshtasticClient.myNodeId;
          const el = document.createElement('div');
          el.className = `msg ${isMe ? 'out' : 'in'}`;

          const timeStr = new Date(msg.timestamp * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

          el.innerHTML = `
        <div class="msg-meta">
            <span>${isMe ? '–í—ã' : (msg.fromName || `Node ${msg.fromId}`)}</span>
        </div>
        <div>${msg.text}</div>
        <div class="msg-time">${timeStr}</div>
      `;

          this.container.appendChild(el);
        });

        this.container.scrollTop = this.container.scrollHeight;
      }

      // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
      send() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if (!text) return;

        if (!meshtasticClient.isConnected) {
          logger.warn('–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –Ω–æ–¥–µ.');
          return;
        }

        meshtasticClient.sendText(text)
          .then(() => {
            // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ —á–∞—Ç (—Ç–∞–∫ –∫–∞–∫ –º—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏)
            this.incomingMessage({
              id: Math.floor(Math.random() * 999999),
              fromId: meshtasticClient.myNodeId,
              fromName: document.getElementById('my-node-name').textContent,
              text: text,
              timestamp: Date.now() / 1000 // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –¥–ª—è –∏—Å—Ö–æ–¥—è—â–µ–≥–æ
            });
            input.value = '';
          })
          .catch(e => logger.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + e.message));
      }
    }

    const chatEngine = new ChatEngine();


    // ==========================================
    // 4. MESHTASTIC CLIENT (–û–°–ù–û–í–ù–û–ô –ö–õ–ò–ï–ù–¢)
    // ==========================================

    class MeshtasticClient {
      constructor() {
        this.mode = 'none';
        this.isConnected = false;
        this.protobufRoot = null;
        this.Types = {};
        this.myNodeId = 0;
        this.nodeDb = new Map(); // –•—Ä–∞–Ω–µ–Ω–∏–µ —É–∑–ª–æ–≤ (NodeID -> {longName, ...})

        this.ble = { device: null, toRadio: null, fromRadio: null };
        this.serial = { port: null, reader: null };
        this.http = { baseUrl: '', pollInterval: null };
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Protobuf
      async initProtobuf() {
        if (this.protobufRoot) return;
        logger.info("–ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π Protobuf...");
        this.protobufRoot = protobuf.Root.fromJSON(MESHTASTIC_PROTO_JSON);
        this.Types.FromRadio = this.protobufRoot.lookupType("meshtastic.FromRadio");
        this.Types.ToRadio = this.protobufRoot.lookupType("meshtastic.ToRadio");
        logger.success("Protobuf –≥–æ—Ç–æ–≤.");
      }

      setMode(mode) {
        this.disconnect();
        document.querySelectorAll('[id^="conn-form-"]').forEach(el => el.style.display = 'none');
        const form = document.getElementById(`conn-form-${mode}`);
        if (form) form.style.display = 'block';
        this.mode = mode;
      }

      updateStatus(connected, text = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ') {
        this.isConnected = connected;
        const badge = document.getElementById('global-status');
        const txt = document.getElementById('status-text');
        const input = document.getElementById('msg-input');
        const btn = document.getElementById('btn-send');

        if (connected) {
          badge.className = 'status-badge connected';
          txt.textContent = text;
          input.disabled = false;
          btn.disabled = false;
        } else {
          badge.className = 'status-badge';
          txt.textContent = '–û—Ç–∫–ª—é—á–µ–Ω–æ';
          input.disabled = true;
          btn.disabled = true;
          this.myNodeId = 0;
          document.getElementById('my-node-id').textContent = 'N/A';
          document.getElementById('my-node-name').textContent = 'N/A';
        }
      }

      disconnect() {
        if (this.mode === 'ble' && this.ble.device) {
          this.ble.device.gatt.disconnect();
        } else if (this.mode === 'serial' && this.serial.reader) {
          // –ù–µ–ª—å–∑—è –ø—Ä–µ—Ä–≤–∞—Ç—å, –ø–æ–∫–∞ –ø–æ—Ä—Ç –æ—Ç–∫—Ä—ã—Ç, —Ç–æ–ª—å–∫–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á—Ç–µ–Ω–∏–µ
          this.serial.reader.cancel();
          this.serial.reader = null;
        } else if (this.mode === 'http' && this.http.pollInterval) {
          clearInterval(this.http.pollInterval);
          this.http.pollInterval = null;
        }
        this.updateStatus(false);
        logger.info(`–û—Ç–∫–ª—é—á–µ–Ω–æ. –†–µ–∂–∏–º: ${this.mode}`);
      }

      // ====================
      // 4.1. BLE LOGIC
      // ====================
      async connectBLE() {
        await this.initProtobuf();
        if (!navigator.bluetooth) return logger.error('Web Bluetooth –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.');

        try {
          this.ble.device = await navigator.bluetooth.requestDevice({
            filters: [{ services: [UUIDS.SERVICE] }]
          });

          this.ble.device.addEventListener('gattserverdisconnected', () => this.updateStatus(false, 'BLE Disconnected'));

          const server = await this.ble.device.gatt.connect();
          const service = await server.getPrimaryService(UUIDS.SERVICE);

          this.ble.fromRadio = await service.getCharacteristic(UUIDS.FROMRADIO);
          await this.ble.fromRadio.startNotifications();
          this.ble.fromRadio.addEventListener('characteristicvaluechanged', (e) => this.handleData(e.target.value));

          this.ble.toRadio = await service.getCharacteristic(UUIDS.TORADIO);

          this.updateStatus(true, 'Bluetooth');
          logger.success('BLE –ø–æ–¥–∫–ª—é—á–µ–Ω–æ.');

        } catch (e) {
          logger.error('–û—à–∏–±–∫–∞ BLE: ' + e.message);
          this.updateStatus(false);
        }
      }

      // ====================
      // 4.2. SERIAL LOGIC
      // ====================
      async connectSerial() {
        await this.initProtobuf();
        if (!navigator.serial) return logger.error('Web Serial –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.');

        try {
          this.serial.port = await navigator.serial.requestPort();
          await this.serial.port.open({ baudRate: 115200 });

          this.serial.reader = this.serial.port.readable.getReader();
          this.updateStatus(true, 'Serial/USB');
          logger.success('USB-–ø–æ—Ä—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω. –û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...');

          this.readSerialLoop();
        } catch (e) {
          logger.error('–û—à–∏–±–∫–∞ Serial: ' + e.message);
          this.updateStatus(false);
        }
      }

      // –≠—Ç–æ –±–∞–∑–æ–≤–∞—è –∑–∞–≥–ª—É—à–∫–∞, –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–µ–Ω Meshtastic-specific Frame Reader
      async readSerialLoop() {
        // –≠—Ç–æ —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–∞–∫–µ—Ç—ã Meshtastic –∏–º–µ—é—Ç 2-–±–∞–π—Ç–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª–∏–Ω—ã.
        // –ó–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ —á–∏—Ç–∞–µ–º –±—É—Ñ–µ—Ä.
        const decoder = new TextDecoder();
        let buffer = new Uint8Array(0);

        while (this.serial.port && this.serial.port.readable) {
          try {
            const { value, done } = await this.serial.reader.read();
            if (done) break;

            // –í WebSerial –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ –≤–∏–¥–µ –±–∞–π—Ç–æ–≤.
            // –î–ª—è Protobuf-–ø–∞–∫–µ—Ç–æ–≤ –∏—Ö –Ω—É–∂–Ω–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å.
            // –ó–¥–µ—Å—å –º—ã –∏–º–∏—Ç–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –ø–∞–∫–µ—Ç–∞.
            this.handleData(value);

          } catch (error) {
            logger.error('Serial read error: ' + error.message);
            break;
          }
        }
        this.updateStatus(false);
      }

      // ====================
      // 4.3. HTTP LOGIC
      // ====================
      async connectHTTP() {
        await this.initProtobuf();
        const ip = document.getElementById('http-ip').value.trim().replace(/\/$/, '');
        this.http.baseUrl = ip;

        try {
          // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤—è–∑—å –∏ –ø–æ–ª—É—á–∞–µ–º NodeInfo
          const response = await fetch(`${ip}/static/api/v1/info`);
          if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
          const info = await response.json();

          this.myNodeId = info.myNodeNum;
          document.getElementById('my-node-id').textContent = info.myNodeNum.toString(16);
          document.getElementById('my-node-name').textContent = info.myNodeName;

          this.updateStatus(true, 'HTTP/Wi-Fi');
          logger.success(`–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ ${ip}. –ù–æ–¥–∞: ${info.myNodeName}`);

          // 2. –ù–∞—á–∏–Ω–∞–µ–º "—Å—Ç—Ä–∏–º–∏–Ω–≥" (–∏–º–∏—Ç–∞—Ü–∏—è long polling)
          this.startHttpPolling();

        } catch (e) {
          logger.error('–û—à–∏–±–∫–∞ HTTP: ' + e.message);
          this.updateStatus(false);
        }
      }

      // –ò–º–∏—Ç–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞–∫–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ REST API
      startHttpPolling() {
        // HTTP API –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø—Ä—è–º–æ–π stream, –∫—Ä–æ–º–µ WebSockets.
        // –î–ª—è "–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞" –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–ø—Ä–æ—Å (polling)
        this.http.pollInterval = setInterval(async () => {
          try {
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º "–ø–æ—Å–ª–µ–¥–Ω–∏–µ" –ø–∞–∫–µ—Ç—ã. –í —Ä–µ–∞–ª—å–Ω–æ–º API Meshtastic —ç—Ç–æ
            // –Ω–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–æ, –Ω–æ –º—ã –∏–º–∏—Ç–∏—Ä—É–µ–º
            const response = await fetch(`${this.http.baseUrl}/static/api/v1/packets`);
            if (!response.ok) return logger.warn('HTTP poll failed');
            const packets = await response.json();

            // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã, –∏–º–∏—Ç–∏—Ä—É–µ–º –æ–¥–∏–Ω –ø–∞–∫–µ—Ç FromRadio
            if (packets && packets.length > 0) {
              // –ó–¥–µ—Å—å –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å raw bytes, –Ω–æ HTTP API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON, 
              // —Ç–∞–∫ —á—Ç–æ –∏–º–∏—Ç–∏—Ä—É–µ–º –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
              const latestPacket = packets[0];
              if (latestPacket.data) {
                // –í —Ä–µ–∞–ª—å–Ω–æ–º API Protobuf –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ Base64.
                // –ú—ã –Ω–µ –º–æ–∂–µ–º –∑–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ –≤–∑—è—Ç—å Base64, –ø–æ—ç—Ç–æ–º—É
                // –¥–ª—è HTTP-—Ä–µ–∂–∏–º–∞ –¥–µ–ª–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–∫—É, –∞ –ø—Ä–∏–µ–º
                // –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤ ChatEngine –¥–ª—è –∏—Å—Ö–æ–¥—è—â–∏—Ö.
              }
            }

          } catch (e) {
            logger.error('HTTP Polling Error: ' + e.message);
          }
        }, 5000); // –û–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
      }

      // ====================
      // 4.4. DATA FLOW
      // ====================

      /**
       * –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥—è—â–∏—Ö –±–∞–π—Ç–æ–≤ (–∏–∑ BLE –∏–ª–∏ Serial)
       * @param {DataView} value - –±–∞–π—Ç—ã –ø–∞–∫–µ—Ç–∞
       */
      handleData(value) {
        const buffer = new Uint8Array(value.buffer || value);

        try {
          const fromRadio = this.Types.FromRadio.decode(buffer);

          // 1. –ú–æ—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
          if (fromRadio.myInfo) {
            this.myNodeId = fromRadio.myInfo.myNodeNum;
            document.getElementById('my-node-id').textContent = this.myNodeId.toString(16);
            logger.success(`–ú–æ–π NodeID: ${this.myNodeId.toString(16)}`);
          }

          // 2. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É–∑–ª–µ
          if (fromRadio.nodeInfo) {
            const num = fromRadio.nodeInfo.num;
            const name = fromRadio.nodeInfo.user?.longName || `Node ${num.toString(16)}`;
            this.nodeDb.set(num, { longName: name, lastSeen: Date.now() });
            this.renderNodes();
            logger.info(`–£–∑–µ–ª –Ω–∞–π–¥–µ–Ω: ${name}`);
          }

          // 3. –ü–∞–∫–µ—Ç –¥–∞–Ω–Ω—ã—Ö (–ß–∞—Ç/—Å–æ–æ–±—â–µ–Ω–∏–µ)
          if (fromRadio.packet) {
            this.processMeshPacket(fromRadio.packet);
          }

        } catch (e) {
          logger.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –ø–∞–∫–µ—Ç FromRadio: " + e.message);
        }
      }

      processMeshPacket(packet) {
        if (!packet.decoded) return;

        // –ü–æ—Ä—Ç 1 = TEXT_MESSAGE_APP
        if (packet.decoded.portnum === 1) {
          const bytes = packet.decoded.payload;
          const text = new TextDecoder("utf-8").decode(bytes);

          const senderInfo = this.nodeDb.get(packet.from);
          const senderName = senderInfo ? senderInfo.longName : `Node ${packet.from.toString(16)}`;

          chatEngine.incomingMessage({
            id: packet.id,
            fromId: packet.from,
            fromName: senderName,
            text: text,
            timestamp: packet.rxTime || Math.floor(Date.now() / 1000) // –ò—Å–ø–æ–ª—å–∑—É–µ–º rxTime –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
          });
          logger.log('DEBUG', `Text Message: "${text}" from ${senderName}`);
        }
      }

      /**
       * –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–æ–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
       * @param {string} text 
       */
      async sendText(text) {
        const payloadBytes = new TextEncoder().encode(text);
        const packetId = Math.floor(Math.random() * 0xFFFFFFFF);

        const packetStruct = {
          to: 0xFFFFFFFF, // Broadcast
          decoded: {
            portnum: 1, // TEXT_MESSAGE_APP
            payload: payloadBytes
          },
          id: packetId
        };

        const toRadioStruct = { packet: packetStruct };
        const err = this.Types.ToRadio.verify(toRadioStruct);
        if (err) throw new Error("Protobuf verification failed: " + err);

        const buffer = this.Types.ToRadio.encode(toRadioStruct).finish();

        if (this.mode === 'ble' && this.ble.toRadio) {
          await this.ble.toRadio.writeValue(buffer);
          logger.info('‚úì BLE message sent.');
        } else if (this.mode === 'serial' && this.serial.port) {
          const writer = this.serial.port.writable.getWriter();
          await writer.write(buffer);
          writer.releaseLock();
          logger.info('‚úì Serial message sent.');
        } else if (this.mode === 'http' && this.http.baseUrl) {
          // HTTP API —á–∞—Å—Ç–æ –æ–∂–∏–¥–∞–µ—Ç Base64, –∞ –Ω–µ Protobuf –±–∞–π—Ç—ã –Ω–∞–ø—Ä—è–º—É—é
          const base64Packet = btoa(String.fromCharCode(...buffer));
          await fetch(`${this.http.baseUrl}/static/api/v1/toRadio`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ payload: base64Packet })
          });
          logger.info('‚úì HTTP message sent.');
        } else {
          throw new Error("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.");
        }
      }

      renderNodes() {
        const container = document.getElementById('node-list-container');
        container.innerHTML = '';

        if (this.nodeDb.size === 0) {
          container.innerHTML = '<p style="color: var(--text-muted);">–ü–æ–∫–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É–∑–ª–∞—Ö.</p>';
          return;
        }

        this.nodeDb.forEach((node, id) => {
          const el = document.createElement('div');
          el.style.cssText = 'background: #2a3850; padding: 10px; border-radius: 6px;';
          el.innerHTML = `
          <strong style="color: var(--accent);">${node.longName}</strong><br>
          <small style="color: var(--text-muted);">ID: ${id.toString(16)}</small><br>
          <small style="color: var(--text-muted);">Last Seen: ${new Date(node.lastSeen).toLocaleTimeString()}</small>
        `;
          container.appendChild(el);
        });
      }
    }

    const meshtasticClient = new MeshtasticClient();

    // ==========================================
    // 5. –ó–ê–ü–£–°–ö
    // ==========================================

    window.onload = () => {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      meshtasticClient.initProtobuf();
    };
  </script>
</body>

</html>